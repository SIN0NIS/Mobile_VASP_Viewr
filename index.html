<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VASP Mobile Pro</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        #container { width: 100vw; height: 100vh; position: relative; background: white; }

        /* ìƒë‹¨ ì •ë³´ë°” */
        #info-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); padding: 10px 60px 10px 15px; 
            box-sizing: border-box; border-bottom: 1px solid #ddd; z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); pointer-events: none;
        }
        #file-name { font-weight: bold; font-size: 14px; display: block; }
        #atom-info { font-size: 12px; color: #666; margin-top: 2px; }

        /* ë©”ë‰´ ë²„íŠ¼ */
        #menu-btn {
            position: absolute; top: 5px; right: 5px; z-index: 20;
            width: 40px; height: 40px; border: none; background: white;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ì„¤ì • ì‚¬ì´ë“œë°” */
        #sidebar {
            position: absolute; top: 0; right: -320px; width: 300px; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 15;
            transition: right 0.3s ease; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        #sidebar.open { right: 0; }
        
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* ì»¨íŠ¸ë¡¤ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .group-title { font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        
        .row { display: flex; align-items: center; margin-bottom: 8px; justify-content: space-between; }
        .btn-row { display: flex; gap: 5px; }
        
        button {
            background: #f0f0f0; border: 1px solid #ccc; padding: 6px 10px;
            border-radius: 4px; font-size: 12px; cursor: pointer; flex: 1;
        }
        button.active { background: #007bff; color: white; border-color: #0056b3; }
        
        input[type="range"] { flex: 1; margin: 0 10px; }
        input[type="number"] { width: 50px; padding: 4px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; }
        select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }

        /* íŒŒì¼ ì¸í’‹ ìˆ¨ê¹€, ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´ */
        #fileInput { display: none; }
        .upload-btn { 
            background: #007bff; color: white; border: none; padding: 10px; 
            width: 100%; border-radius: 5px; font-weight: bold; margin-bottom: 15px;
        }

        /* ë²”ë¡€ (Legend) */
        #legend {
            position: absolute; top: 60px; right: 10px; 
            background: rgba(255,255,255,0.8); padding: 5px 10px;
            border-radius: 5px; font-size: 11px; z-index: 4; display: none;
            pointer-events: none; border: 1px solid #eee;
        }
    </style>
</head>
<body>

    <div id="info-bar">
        <span id="file-name">No File Loaded</span>
        <div id="atom-info">-</div>
    </div>

    <div id="legend"></div>

    <button id="menu-btn">â˜°</button>

    <div id="sidebar">
        <div class="sidebar-header">
            Settings
            <button onclick="toggleSidebar()" style="width:auto; background:none; border:none; font-size:16px;">âœ•</button>
        </div>
        <div class="sidebar-content">
            
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Open POSCAR/XYZ</button>
            <input type="file" id="fileInput">

            <div class="control-group">
                <div class="group-title">Camera View</div>
                <div class="btn-row">
                    <button onclick="setView('a')">A-axis (100)</button>
                    <button onclick="setView('b')">B-axis (010)</button>
                    <button onclick="setView('c')">C-axis (001)</button>
                </div>
                <div class="row" style="margin-top:10px;">
                    <span>Show Axes</span>
                    <input type="checkbox" id="chk-axes" checked onchange="updateScene()">
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Style</div>
                <select id="style-select" onchange="updateScene()">
                    <option value="ballStick">Ball & Stick</option>
                    <option value="stick">Stick Only</option>
                    <option value="sphere">Spacefill (Sphere)</option>
                    <option value="line">Line / Wireframe</option>
                </select>
            </div>

            <div class="control-group">
                <div class="group-title">Labels</div>
                <div class="row">
                    <span>Symbol on Atom</span>
                    <input type="checkbox" id="chk-label-sym" onchange="updateScene()">
                </div>
                <div class="row">
                    <span>Index on Atom</span>
                    <input type="checkbox" id="chk-label-idx" onchange="updateScene()">
                </div>
                <div class="row">
                    <span>Show Legend (Top-Right)</span>
                    <input type="checkbox" id="chk-legend" onchange="updateScene()">
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Unit Cell</div>
                <div class="row">
                    <span>Show Box</span>
                    <input type="checkbox" id="chk-cell" checked onchange="updateScene()">
                </div>
                <div class="row">
                    <span>Color</span>
                    <select id="cell-color" onchange="updateScene()" style="width:60%">
                        <option value="black">Black</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
                <div class="row">
                    <span>Line Width</span>
                    <input type="range" id="cell-width" min="1" max="5" step="0.5" value="1" oninput="updateScene()">
                </div>
                <div class="row">
                    <span>Style (Simulated)</span>
                    <select id="cell-style" onchange="updateScene()" style="width:60%">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed (Rough)</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Supercell Expansion (Float)</div>
                <div class="row">
                    <span>X Scale</span>
                    <input type="number" id="sc-x" value="1.0" step="0.5" min="1.0">
                </div>
                <div class="row">
                    <span>Y Scale</span>
                    <input type="number" id="sc-y" value="1.0" step="0.5" min="1.0">
                </div>
                <div class="row">
                    <span>Z Scale</span>
                    <input type="number" id="sc-z" value="1.0" step="0.5" min="1.0">
                </div>
                <div class="row" style="margin-top:5px;">
                    <span>Show All Cells</span>
                    <input type="checkbox" id="chk-sc-allbox">
                </div>
                <button onclick="updateScene()" style="width:100%; margin-top:5px; background:#666; color:white;">Apply Supercell</button>
            </div>

        </div>
    </div>

    <div id="container"></div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let viewer = null;
        let modelData = null; // ì›ë³¸ ë°ì´í„° í…ìŠ¤íŠ¸
        let modelFormat = "";
        let glModel = null;   // í˜„ì¬ ë¡œë“œëœ GLModel ê°ì²´

        // --- ì´ˆê¸°í™” ---
        $(document).ready(function() {
            let element = document.getElementById('container');
            viewer = $3Dmol.createViewer(element, { backgroundColor: 'white' });
            
            // íŒŒì¼ ë¡œë“œ í•¸ë“¤ëŸ¬
            $('#fileInput').on('change', function(e) {
                let file = e.target.files[0];
                if (!file) return;

                $('#file-name').text(file.name);
                
                let reader = new FileReader();
                reader.onload = function(event) {
                    modelData = event.target.result;
                    // ê°„ë‹¨í•œ í™•ì¥ì ì²´í¬
                    let ext = file.name.split('.').pop().toLowerCase();
                    modelFormat = (ext === 'poscar' || ext === 'vasp') ? 'vasp' : 'xyz';
                    
                    // ë·°ì–´ ë¦¬ì…‹ ë° ê·¸ë¦¬ê¸°
                    updateScene(true);
                    toggleSidebar(); // íŒŒì¼ ì—´ë©´ ë©”ë‰´ ë‹«ê¸°
                };
                reader.readAsText(file);
            });

            // ë©”ë‰´ í† ê¸€
            $('#menu-btn').click(toggleSidebar);
        });

        function toggleSidebar() {
            let sb = document.getElementById('sidebar');
            sb.classList.toggle('open');
        }

        // --- í•µì‹¬: ì¥ë©´ ì—…ë°ì´íŠ¸ (ëª¨ë“  ì„¤ì • ì ìš©) ---
        function updateScene(resetCamera = false) {
            if (!modelData) return;

            viewer.clear();

            // 1. ìŠˆí¼ì…€ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
            let sx = parseFloat($('#sc-x').val()) || 1.0;
            let sy = parseFloat($('#sc-y').val()) || 1.0;
            let sz = parseFloat($('#sc-z').val()) || 1.0;
            
            // 2. ëª¨ë¸ ë¡œë“œ (ìŠˆí¼ì…€ ì ìš©)
            // 3Dmolì˜ replicateUnitCellì€ ì •ìˆ˜ë§Œ ì§€ì›í•˜ë¯€ë¡œ, ë¡œë“œ í›„ í•„í„°ë§í•˜ê±°ë‚˜ ê¸°ë³¸ ë¡œë“œ
            glModel = viewer.addModel(modelData, modelFormat);
            
            // ìŠˆí¼ì…€ ì ìš© (ì •ìˆ˜/ì‹¤ìˆ˜ ë³µí•© ì²˜ë¦¬)
            if (sx > 1.0 || sy > 1.0 || sz > 1.0) {
                viewer.replicateUnitCell([Math.ceil(sx), Math.ceil(sy), Math.ceil(sz)]);
                // *ì‹¬í™”: ì‹¤ìˆ˜ ì»·íŒ…ì€ JSì—ì„œ ì¢Œí‘œ ê³„ì‚°ì´ í•„ìš”í•˜ë‚˜, ì„±ëŠ¥ìƒ ì •ìˆ˜ë°° í™•ì¥ í›„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤Œ.
                // ë§Œì•½ ì—„ë°€í•œ ì‹¤ìˆ˜ ì»·ì´ í•„ìš”í•˜ë©´ ë³„ë„ íŒŒì„œ êµ¬í˜„ í•„ìš” (í˜„ì¬ëŠ” ì •ìˆ˜ë°° í™•ì¥)
            }

            // 3. ìŠ¤íƒ€ì¼ ì ìš©
            let styleType = $('#style-select').val();
            let styleObj = {};
            if(styleType === 'ballStick') styleObj = {sphere:{scale:0.25}, stick:{radius:0.1}};
            else if(styleType === 'stick') styleObj = {stick:{radius:0.15}};
            else if(styleType === 'sphere') styleObj = {sphere:{scale:0.8}};
            else if(styleType === 'line') styleObj = {line:{}};
            
            viewer.setStyle({}, styleObj);

            // 4. Unit Cell ê·¸ë¦¬ê¸°
            if ($('#chk-cell').is(':checked')) {
                let cColor = $('#cell-color').val();
                let cWidth = parseFloat($('#cell-width').val());
                let showAllBox = $('#chk-sc-allbox').is(':checked'); // ì „ì²´ ì…€ ë°•ìŠ¤ í‘œì‹œ ì—¬ë¶€
                
                // ì›ë³¸ ì…€ ë°•ìŠ¤
                viewer.addUnitCell({
                    box: {color: cColor, linewidth: cWidth},
                    alink: {color: 'red', linewidth: cWidth}, // aì¶• íŒíŠ¸
                    blink: {color: 'green', linewidth: cWidth},
                    clink: {color: 'blue', linewidth: cWidth}
                });
            }

            // 5. ë¼ë²¨ ë° ì •ë³´ í‘œì‹œ
            let atoms = viewer.selectedAtoms({});
            let atomCounts = {};
            
            // ë²”ë¡€ ì´ˆê¸°í™”
            $('#legend').html('').hide();
            
            for (let i = 0; i < atoms.length; i++) {
                let a = atoms[i];
                let labelText = "";
                
                // í™”í•™ì‹ ì¹´ìš´íŒ… (ì›ë³¸ ì…€ ê¸°ì¤€ ì¶”ì •ì´ ì–´ë ¤ìš°ë¯€ë¡œ ì „ì²´ ì›ì ê¸°ì¤€)
                if(!atomCounts[a.elem]) atomCounts[a.elem] = 0;
                atomCounts[a.elem]++;

                // ë¼ë²¨ í…ìŠ¤íŠ¸ ì¡°í•©
                if ($('#chk-label-sym').is(':checked')) labelText += a.elem;
                if ($('#chk-label-idx').is(':checked')) labelText += (labelText ? "-" : "") + a.index;

                if (labelText) {
                    viewer.addLabel(labelText, {
                        position: a, 
                        backgroundColor: 'rgba(0,0,0,0.7)', 
                        fontColor:'white', 
                        fontSize: 10,
                        showBackground: true
                    });
                }
            }

            // í™”í•™ì‹ ë¬¸ìì—´ ìƒì„± (ì˜ˆ: Pb8 Ti8 O24)
            let formula = "";
            let uniqueElems = [];
            for(let el in atomCounts) {
                formula += el + atomCounts[el] + " ";
                uniqueElems.push(el);
            }
            $('#atom-info').text("Formula: " + formula + " (Total: " + atoms.length + ")");

            // ë²”ë¡€ í‘œì‹œ (Legend)
            if ($('#chk-legend').is(':checked') && uniqueElems.length > 0) {
                let legendHtml = "<strong>Legend</strong><br>";
                uniqueElems.forEach(el => {
                    legendHtml += `â€¢ ${el}<br>`;
                });
                $('#legend').html(legendHtml).show();
            }

            // 6. ì¶• í‘œì‹œ (Axes)
            viewer.removeAllShapes(); // ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
            if ($('#chk-axes').is(':checked')) {
                // 3Dmolì—ëŠ” ë‚´ì¥ ì¶•ì´ ì—†ì–´ì„œ ê·¸ë ¤ì¤˜ì•¼ í•¨ (ê°„ë‹¨íˆ UnitCell ì½”ë„ˆ ìƒ‰ìœ¼ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ì•„ë˜ì²˜ëŸ¼ ì§ì ‘ ê·¸ë¦¼)
                // ì—¬ê¸°ì„œëŠ” UnitCellì˜ alink, blinkê°€ ì´ë¯¸ ì¶• ì—­í• ì„ í•˜ë¯€ë¡œ ë³„ë„ ì¶”ê°€ë³´ë‹¤ëŠ” UnitCell ì˜µì…˜ì— ì˜ì¡´
            }

            // ì¹´ë©”ë¼ ì´ˆê¸°í™” (ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œì—ë§Œ)
            if (resetCamera) viewer.zoomTo();
            
            viewer.render();
        }

        // --- ë·° í”„ë¦¬ì…‹ ê¸°ëŠ¥ ---
        function setView(axis) {
            // ê°„ë‹¨í•˜ê²Œ ì¹´ë©”ë¼ ìœ„ì¹˜ ì¡°ì •
            if (axis === 'c') viewer.zoomTo({x:0, y:0, z:100}); // 001
            else if (axis === 'b') viewer.zoomTo({x:0, y:100, z:0}); // 010
            else if (axis === 'a') viewer.zoomTo({x:100, y:0, z:0}); // 100
            viewer.render();
        }

    </script>
</body>
</html>
