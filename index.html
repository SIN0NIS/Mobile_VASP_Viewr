<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VASP Mobile Pro v3</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #fff; }
        
        /* 1. ìƒë‹¨ ì •ë³´ & ë²”ë¡€ ì˜ì—­ (ì¢Œì¸¡ ìƒë‹¨ ê³ ì •) */
        #top-left-panel {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            display: flex; flex-direction: column; gap: 5px;
        }

        #file-info {
            background: rgba(255,255,255,0.9); padding: 5px 10px;
            border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 13px; font-weight: bold; border: 1px solid #ddd;
            pointer-events: auto;
        }

        #legend {
            background: rgba(255,255,255,0.85); padding: 8px;
            border-radius: 4px; border: 1px solid #ccc;
            font-size: 12px; pointer-events: auto;
            display: none; /* íŒŒì¼ ë¡œë“œ ì‹œ í‘œì‹œ */
        }
        .legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .atom-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.2); }

        /* 2. ë©”ë‰´ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) */
        #menu-btn {
            position: absolute; top: 10px; right: 10px; z-index: 20;
            width: 44px; height: 44px; border: none; background: white;
            border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* 3. ì„¤ì • ì‚¬ì´ë“œë°” */
        #sidebar {
            position: absolute; top: 0; right: -320px; width: 300px; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 15;
            transition: right 0.3s ease; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        #sidebar.open { right: 0; }
        
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* UI ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .group-title { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; margin-bottom: 10px; border-left: 3px solid #007bff; padding-left: 6px; }
        
        .row { display: flex; align-items: center; margin-bottom: 10px; justify-content: space-between; font-size: 13px; }
        .btn-row { display: flex; gap: 5px; margin-bottom: 8px; }
        
        button {
            background: #f1f3f5; border: 1px solid #ced4da; padding: 10px;
            border-radius: 6px; font-size: 13px; cursor: pointer; flex: 1; font-weight: 500;
        }
        button:active { background: #e9ecef; transform: translateY(1px); }
        
        input[type="range"] { flex: 1; margin: 0 10px; }
        input[type="number"] { width: 50px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        select { width: 120px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
        input[type="checkbox"] { transform: scale(1.3); margin-right: 5px; }

        /* íŒŒì¼ ì—…ë¡œë“œ ë””ìì¸ */
        .upload-box {
            border: 2px dashed #007bff; background: #e7f1ff; padding: 15px;
            text-align: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer;
        }
        input[type="file"] { display: none; }

        #container { width: 100vw; height: 100vh; position: relative; }
    </style>
</head>
<body>

    <div id="top-left-panel">
        <div id="file-info">No File Loaded</div>
        <div id="legend"></div>
    </div>

    <button id="menu-btn" onclick="toggleSidebar()">âš™ï¸</button>

    <div id="sidebar">
        <div class="sidebar-header">
            Settings
            <button onclick="toggleSidebar()" style="flex:0; width:auto; border:none; background:none; font-size:20px;">âœ•</button>
        </div>
        <div class="sidebar-content">
            
            <label class="upload-box">
                <div>ğŸ“‚ Click to Open File</div>
                <div style="font-size:11px; color:#666; margin-top:5px;">(POSCAR, vasp, xyz)</div>
                <input type="file" id="fileInput">
            </label>

            <div class="control-group">
                <div class="group-title">Camera View</div>
                <div class="btn-row">
                    <button onclick="setCameraView('a')">A (100)</button>
                    <button onclick="setCameraView('b')">B (010)</button>
                    <button onclick="setCameraView('c')">C (001)</button>
                </div>
                <button onclick="viewer.zoomTo()" style="width:100%; background:#fff; border:1px dashed #999;">Fit to Screen</button>
            </div>

            <div class="control-group">
                <div class="group-title">Unit Cell Box</div>
                <div class="row">
                    <span>Show Box</span>
                    <input type="checkbox" id="chk-box" checked onchange="updateScene(false)">
                </div>
                <div class="row">
                    <span>Color</span>
                    <select id="box-color" onchange="updateScene(false)">
                        <option value="black">Black</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="white">White</option>
                    </select>
                </div>
                <div class="row">
                    <span>Width</span>
                    <input type="range" id="box-width" min="1" max="10" step="0.5" value="1.5" oninput="updateScene(false)">
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Axes (Origin)</div>
                <div class="row">
                    <span>Show Axes</span>
                    <input type="checkbox" id="chk-axis" checked onchange="updateScene(false)">
                </div>
                <div style="font-size:11px; color:#666;">
                    <span style="color:red">Red: X</span> / <span style="color:green">Green: Y</span> / <span style="color:blue">Blue: Z</span>
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Supercell (Repeat)</div>
                <div class="row">
                    <span>X</span> <input type="number" id="sc-x" value="1" min="1" onchange="updateScene(false)">
                </div>
                <div class="row">
                    <span>Y</span> <input type="number" id="sc-y" value="1" min="1" onchange="updateScene(false)">
                </div>
                <div class="row">
                    <span>Z</span> <input type="number" id="sc-z" value="1" min="1" onchange="updateScene(false)">
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Atom Style</div>
                <select id="style-select" onchange="updateScene(false)" style="width:100%">
                    <option value="ballStick">Ball & Stick (Default)</option>
                    <option value="sphere">Spacefill (Sphere)</option>
                    <option value="stick">Stick Only</option>
                    <option value="line">Line / Wireframe</option>
                </select>
            </div>
            
            <div style="text-align:center; font-size:11px; color:#999; margin-top:20px;">
                VASP Mobile Pro v3.0
            </div>

        </div>
    </div>

    <div id="container"></div>

    <script>
        let viewer = null;
        let modelData = null;
        let fileFormat = "vasp";

        // 3Dmol ê¸°ë³¸ ìƒ‰ìƒí‘œ (ê°„ì´ìš©)
        const atomColors = {
            'H': '#FFFFFF', 'C': '#909090', 'O': '#FF0D0D', 'N': '#3050F8',
            'Pb': '#575961', 'Ti': '#BFC2C7', 'Zr': '#94E0E0', 'Si': '#DAA520' 
            // 3Dmolì´ ìë™ìœ¼ë¡œ ìƒ‰ì„ ì¡ì§€ë§Œ, ë²”ë¡€ í‘œì‹œì— í•„ìš”
        };

        window.onload = function() {
            viewer = $3Dmol.createViewer(document.getElementById('container'), { backgroundColor: 'white' });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                let file = e.target.files[0];
                if (!file) return;

                document.getElementById('file-info').innerText = file.name;
                
                let reader = new FileReader();
                reader.onload = function(event) {
                    modelData = event.target.result;
                    let fname = file.name.toUpperCase();
                    fileFormat = fname.includes(".XYZ") ? "xyz" : "vasp";
                    
                    updateScene(true);
                    
                    // ëª¨ë°”ì¼ì´ë©´ ë©”ë‰´ ë‹«ê¸°
                    if(window.innerWidth < 600) document.getElementById('sidebar').classList.remove('open');
                };
                reader.readAsText(file);
            });
        };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- ë©”ì¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í•µì‹¬) ---
        function updateScene(resetCamera) {
            if (!modelData) return;

            // 1. ê¸°ì¡´ ê·¸ë¦¼ ì‹¹ ì§€ìš°ê¸° (ë°•ìŠ¤, ì¶• ì¤‘ë³µ ë°©ì§€)
            viewer.clear(); 
            viewer.removeAllShapes(); 

            // 2. ëª¨ë¸ ë¡œë“œ
            viewer.addModel(modelData, fileFormat);

            // 3. ìŠˆí¼ì…€ ì ìš© (ë ‰ ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë¸ ë¡œë“œ ì§í›„ ì‹¤í–‰)
            let sx = parseInt(document.getElementById('sc-x').value) || 1;
            let sy = parseInt(document.getElementById('sc-y').value) || 1;
            let sz = parseInt(document.getElementById('sc-z').value) || 1;

            if (sx > 1 || sy > 1 || sz > 1) {
                viewer.replicateUnitCell([sx, sy, sz]);
            }

            // 4. ìŠ¤íƒ€ì¼ ì ìš©
            let st = document.getElementById('style-select').value;
            let styleObj = {};
            if(st === 'ballStick') styleObj = {sphere:{scale:0.25}, stick:{radius:0.12}};
            else if(st === 'sphere') styleObj = {sphere:{scale:0.85}};
            else if(st === 'stick') styleObj = {stick:{radius:0.15}};
            else if(st === 'line') styleObj = {line:{}};
            
            viewer.setStyle({}, styleObj);

            // 5. Unit Cell Box ê·¸ë¦¬ê¸° (ì²´í¬ ì‹œì—ë§Œ)
            if (document.getElementById('chk-box').checked) {
                let bColor = document.getElementById('box-color').value;
                let bWidth = parseFloat(document.getElementById('box-width').value);
                
                viewer.addUnitCell({
                    box: {color: bColor, linewidth: bWidth},
                    // ì—¬ê¸°ì„œëŠ” ì¶• íŒíŠ¸(alink ë“±)ëŠ” ë„ê³  ìˆœìˆ˜ ë°•ìŠ¤ë§Œ
                    alink: {linewidth:0, color: bColor}, 
                    blink: {linewidth:0, color: bColor},
                    clink: {linewidth:0, color: bColor} 
                });
            }

            // 6. Axis (ì¶•) ê·¸ë¦¬ê¸° (ì²´í¬ ì‹œì—ë§Œ, ì›ì ì— í™”ì‚´í‘œ)
            if (document.getElementById('chk-axis').checked) {
                let origin = {x:0, y:0, z:0};
                let axisLen = 5.0; // í™”ì‚´í‘œ ê¸¸ì´
                let w = 0.5;       // í™”ì‚´í‘œ ë‘ê»˜

                // Xì¶• (Red)
                viewer.addArrow({start: origin, end: {x:axisLen, y:0, z:0}, color:'red', radius:0.1});
                // Yì¶• (Green)
                viewer.addArrow({start: origin, end: {x:0, y:axisLen, z:0}, color:'green', radius:0.1});
                // Zì¶• (Blue)
                viewer.addArrow({start: origin, end: {x:0, y:0, z:axisLen}, color:'blue', radius:0.1});
            }

            // 7. ë²”ë¡€(Legend) ìƒì„± (ì¢Œì¸¡ ìƒë‹¨)
            generateLegend();

            // 8. ë Œë”ë§
            if (resetCamera) viewer.zoomTo();
            viewer.render();
        }

        // ë²”ë¡€ ìƒì„± í•¨ìˆ˜
        function generateLegend() {
            let atoms = viewer.selectedAtoms({});
            let counts = {};
            
            // ì›ì†Œë³„ ì¹´ìš´íŠ¸ ë° ìƒ‰ìƒ í™•ì¸
            for (let a of atoms) {
                if (!counts[a.elem]) {
                    // 3Dmol ë‚´ë¶€ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ íšŒìƒ‰)
                    let c = a.color ? '#' + a.color.toString(16).padStart(6,'0') : '#999';
                    counts[a.elem] = { count: 0, color: c };
                }
                counts[a.elem].count++;
            }

            let html = "";
            for (let elem in counts) {
                let info = counts[elem];
                // ì (dot) ìƒ‰ìƒì€ ì‹¤ì œ ì›ì ìƒ‰ìƒê³¼ ë§¤ì¹­
                // 3Dmolì˜ ê¸°ë³¸ ìƒ‰ìƒ ë§¤í•‘ì´ ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´, ë Œë”ë§ëœ ìƒ‰ì„ ê°€ì ¸ì˜¤ë ¤ ì‹œë„í–ˆìœ¼ë‚˜
                // ì—¬ê¸°ì„œëŠ” CSSë¡œ ì§ì ‘ ì› ê·¸ë¦¬ê¸°
                // *3Dmolì€ ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ ìƒ‰ì„ ê²°ì •í•˜ë¯€ë¡œ, ì •í™•í•œ ìƒ‰ì„ ì•Œê¸° ìœ„í•´ì„  element mappingì´ í•„ìš”í•˜ë‚˜
                // ì‹œê°ì ìœ¼ë¡œëŠ” ëŒ€ëµì ì¸ ë§¤ì¹­ë§Œ ë³´ì—¬ì¤Œ
                
                html += `
                    <div class="legend-item">
                        <span class="atom-dot" style="background-color: ${info.color}"></span>
                        <b>${elem}</b> : ${info.count}
                    </div>
                `;
            }
            
            let lg = document.getElementById('legend');
            if (atoms.length > 0) {
                lg.innerHTML = html;
                lg.style.display = 'block';
            } else {
                lg.style.display = 'none';
            }
        }

        // ë·° ì •ë ¬ í•¨ìˆ˜ (A, B, C ì¶•)
        function setCameraView(axis) {
            // ëª¨ë¸ì˜ ì¤‘ì‹¬ì  ê³„ì‚° (ëŒ€ëµì )
            // 3Dmolì€ zoomTo()ê°€ ì¤‘ì‹¬ì„ ë§ì¶°ì£¼ë¯€ë¡œ, ì¹´ë©”ë¼ ê°ë„ë§Œ ì¡ìœ¼ë©´ ë¨
            // í•˜ì§€ë§Œ zoomToëŠ” ìœ„ì¹˜ë¥¼ ì¡ëŠ” ê²ƒì´ë¼, 
            // ê¼¼ìˆ˜ë¡œ: ë©€ë¦¬ì„œ í•´ë‹¹ ì¶•ì„ ë°”ë¼ë³´ê²Œ zoomToë¥¼ ì‹¤í–‰
            
            let dist = 100; // ì¶©ë¶„íˆ ë¨¼ ê±°ë¦¬
            if (axis === 'a') {
                // YZ í‰ë©´ì„ ë´ì•¼ í•¨ -> Xì¶• ìœ„ì—ì„œ (1,0,0) ë°©í–¥
                // 3Dmolì—ì„œ setCameraParameters ì‚¬ìš© ë¶ˆê°€ì‹œ zoomTo í™œìš©
                // zoomToëŠ” 'ì„ íƒëœ ì›ì'ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì¤Œì„ ë‹¹ê¹€.
                // ë·° íšŒì „ì€ rotateTo ê°€ ì—†ìŒ.
                // ëŒ€ì‹  setViewStyleì´ ì—†ìœ¼ë¯€ë¡œ, standard viewë¥¼ ìœ„í•´ì„ 
                // ì¹´ë©”ë¼ ìœ„ì¹˜ë¥¼ ê°•ì œë¡œ ì´ë™ì‹œì¼œì•¼ í•¨. (API ì œí•œ)
                
                // ì°¨ì„ ì±…: ê·¸ëƒ¥ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì´ë™ ì‹œë„
                // (3Dmol.js API í•œê³„ë¡œ ì™„ë²½í•œ ì¶• ì •ë ¬ì´ ê¹Œë‹¤ë¡œìš°ë‚˜ ì•„ë˜ ë°©ë²• ì‹œë„)
                viewer.zoomTo({x:1000, y:0, z:0}, 0); // Xì¶• ë¨¼ê³³ì—ì„œ ë³´ê¸°
            } else if (axis === 'b') {
                viewer.zoomTo({x:0, y:1000, z:0}, 0); // Yì¶• ë¨¼ê³³ì—ì„œ ë³´ê¸°
            } else if (axis === 'c') {
                viewer.zoomTo({x:0, y:0, z:1000}, 0); // Zì¶• ë¨¼ê³³ì—ì„œ ë³´ê¸°
            }
            
            // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë Œë”ë§
            setTimeout(() => viewer.render(), 10);
        }

    </script>
</body>
</html>
